.. _design_uc01 :

Query and access existing thematic content
==========================================


This use case aims at using TEP Urban for user exploration of the registered thematic data collection, visualize, share and download them.


Data Discovery and selection
----------------------------

The first step for the user is to discover and search dataset in :ref:`class_terradue_1_1_tep_1_1_collection` within :ref:`class_terradue_1_1_tep_1_1_thematic_application`.

The following first figure depicts this step using the integrated geobrowser of the portal and the basic visualization functions.


.. uml::
  :caption: Data discovery, query, visualization and selection on portal geobrowser


  actor "User" as U
  participant "Portal" as P
  database "Portal database" as PDB
  database "Catalogue" as C
  participant "Feature Server" as FS
  
  autonumber
  
  U -> P : Query Thematic Application
  activate P
  P <-> PDB : Load Thematic Applications items
  PDB -> P : Data Collections, Services, Maps, Features...
  P -> U : Thematic Application
  deactivate P

  U -> P : Query Collection with params (AOI, timespan, filters...)
  activate P
  P -> C : Query catalogue index of the collection
  C -> P : Datasets metadata (atom, geojson...)
  P -> FS : Get visualization features (WMS, WFS, TMS...)
  FS -> P : return features
  P -> U : Datasets information and visualization features
  deactivate P


Next figure depicts the next step that consists of selecting and saving a dataset selection. Then download or share the full selection.


.. uml::
  :caption: Data selection, download and share on portal geobrowser sequence diagram

  actor "User" as U
  participant "Portal" as P
  database "Portal database" as PDB
  database "Catalogue" as C
  participant "Feature Server" as FS
  participant "Data Gateway" as DG
  database "Data Provider" as DP

  U -> P : Select datasets in the basket
  U -> P : Save basket as a data package
  activate P
  P <-> PDB : Save user data package
  P -> U : Data package
  deactivate P

  U -> P : Download data package
  P -> U : redirect to DG
  U -> DG : download data package
  activate DG
  DG <-> P : query data package
  DG <-> C : query the possible locations
  DG -> DG : resolve the best locations
  DG -> U : download links (direct, metalink)
  deactivate DG

  alt Partnership policy 1 or 2

  U <-> DG : Download files

  else Partnership policy 3

  U <-> DP : Download files

  end


On demand data processing
-------------------------


Some dataset can be asked on demand by the user to the production center or within its own sandbox.

Next figure depicts the sequence that consists of requesting a processing on demand based on the previous dataset selection.


.. uml::
  :caption: On demand data processing submission


  actor "User" as U
  participant "Portal" as P
  database "Portal database" as PDB
  participant "Web Processing Service" as WPS

  U -> P : Select processing service
  P -> U : Processing service description (input, output...)

  alt direct remote WPS

  U -> WPS : submit WPS execute request
  activate WPS
  WPS -> U : WPS process id
  deactivate WPS
  U -> P : save processing job information
  activate P
  P -> PDB : save job
  P -> U : return job id
  deactivate P

  else proxied remote WPS

  U -> P : submit WPS execute request
  activate P
  P -> P : proxy WPS request
  activate P #DarkSalmon
  P -> WPS : submit WPS execute request
  activate WPS
  WPS -> P : WPS process id
  deactivate WPS
  deactivate P
  P -> U : WPS process id
  U -> P : save processing job information
  P -> PDB : save job
  P -> U : return job id
  deactivate P

  end


.. warning:: 
  
  This scenario illustration does not take into account the quota and credit management on purpose for readibility reason. All details about accounting operations that may apply to this scenario are described in the :ref:`dynamic_accounting` section.


Data Visualization using PUMA
-----------------------------


Next figure depicts the same use case but using PUMA for the data vizualisation and manipulation.

.. uml::
  :caption: Data discovery, query, visualization and combination on PUMA


  actor "User" as U
  participant "Portal" as P
  database "Portal database" as PDB
  database "PUMA" as PUMA
  
  autonumber

  U -> P : Select Data Set for the exploration in PUMA
  U -> P : Visualize chosen data set in PUMA
  activate P
  P -> PUMA : Choose data set
  P -> PUMA : Prepare the default visualization for user
  P -> U : Redirect to PUMA
  deactivate P

  activate PUMA
  PUMA -> U : Interface with chosen data set and default visualizations
  U -> PUMA : Show Additional Charts about the data
  PUMA -> U : Showing the additional charts
  U -> PUMA : Filter the data set by year
  PUMA -> U : Showing filtered data set.
  U -> PUMA : Show another layer on top of current as overlay
  PUMA -> U : Showing layer on top of current
  deactivate PUMA





